<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>xChat -Responsive Multi-purpose HTML5 Template</title>
    <meta name="description" content="Cabe - Responsive Multi-purpose HTML5 Template">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- STYLESHEETS -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700" rel="stylesheet">
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css" media="all">
    <link rel="stylesheet" href="css/owl.theme.default.min.css" type="text/css" media="all">

    <link rel="stylesheet" href="css/themify-icons.css">

    <link rel="stylesheet" href="main.min.css" type="text/css" media="all">


    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

<!-- page tour modal -->

<div class="modal fade show" id="pagetour">
    <div class="modal-dialog modal-lg modal-md modal-dialog-centered modal-dialog-zoom">
        <div class="modal-content text-center" style="background-image: url(images/bg-2.png);">
            <div class="owl-carousel owl-theme slider-1">
                <div class="item">
                    <img src="images/bg-1.jpg" alt="modal">
                    <h4 class="text-primary">欢迎您来到某不知名聊天室!</h4>
                    <button type="button" class="btn btn-link tour-close-btn" data-dismiss="modal"
                            aria-label="Close">跳过
                    </button>
                    <button type="button" class="btn btn-primary start-tour">继续</button>

                </div>
                <div class="item">
                    <img src="images/bg-1.jpg" alt="modal">
                    <h4 class="text-primary">在这里，您可以与您的朋友畅聊!</h4>
                    <button type="button" class="btn btn-link tour-close-btn" data-dismiss="modal"
                            aria-label="Close">跳过
                    </button>
                    <button type="button" class="btn btn-primary next-tour">继续</button>
                </div>
                <div class="item">
                    <img src="images/bg-1.jpg" alt="modal">
                    <h4 class="text-primary">希望您喜欢我们的某不知名聊天室!</h4>
                    <button type="button" class="btn btn-primary start-tour tour-close-btn">太棒了!</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- page tour modal -->

<!-- add friend modal -->
<div class="modal fade show" id="addfriend">
    <div class="modal-dialog modal-md modal-md modal-dialog-centered modal-dialog-zoom">
        <div class="modal-content pb-0 d-flex justify-content-between text-center">
            <div class="modal-content pb-0">
                <div class="modal-header add-friend">
                    <h5 class="modal-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                             fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                             stroke-linejoin="round" class="feather feather-user-plus mr-2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        Add Friends
                    </h5>
                    <button type="button" class="close" data-dismiss="addfriend" aria-label="close"
                            id="addfriend-close">
                        <i class="ti-close text-white"></i>
                    </button>
                </div>
                <div class="modal-body add-friend pl-4 pr-4">
                    <div class="alert alert-info text-left">Send invitations to friends.</div>
                    <form>
                        <div class="form-group text-left">
                            <label for="emails" class="col-form-label">Email addresses</label>
                            <input type="text" class="form-control" id="emails">
                        </div>
                        <div class="form-group text-left">
                            <label for="message" class="col-form-label">Invitation message</label>
                            <textarea class="form-control" id="message"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer add-friend">
                    <button type="button" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- add friend modal -->

<!-- main wrapper -->
<div class="main-wrapper">
    <!-- navigation -->
    <nav class="navigation">
        <div class="container pl-0 pr-0">
            <div class="nav-content">
                <ul>
                    <li class="logo d-none d-xl-block d-lg-block"><a href="#"><img src="images/logo.png"
                                                                                   alt="logo"></a></li>
                    <li><a href="#" class="active nav-content-bttn" data-tab="chats" id="chat-list"><span
                            class="circle-icon bg-warning"></span><i class="ti-comments"></i></a></li>
                    <li><a href="#" class="active nav-content-bttn" data-tab="group-chat" id="group-chat-list"><span
                            class="circle-icon bg-success"></span><i class="ti-comments"></i></a></li>
                    <li><a href="#" class="nav-content-bttn" data-tab="friends" id="friend-list"><span
                            class="circle-icon bg-danger"></span><i class="ti-user"></i></a></li>
                    <li class="d-none d-xl-block d-lg-block night-mode"><a href="#"><i
                            class="ti-flickr-alt"></i></a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- navigation -->
    <div class="right-content">
        <div class="left-sidebar">

            <div class="chat-header">
                <div class="chat-header-user">
                    <figure class="avatar">
                        <a href="#" class="profile-detail-bttn"><img src="images/user-7.png" class="rounded-circle"
                                                                     alt="image"></a>
                    </figure>
                    <div>
                        <h5 class="mt-0 mb-0" id="left-top-name">User</h5>
                        <small class="text-success" id="left-top-email">Email</small>
                    </div>
                </div>
                <div class="chat-header-action nav-content">
                    <ul class="list-inline mb-1 mt-3">
                        <li class="list-inline-item mr-3"><a href="../login/login.html" id="log-out"><i
                                class="ti-lock"></i></a>
                        </li>
                        <li class="list-inline-item mr-3"><a href="#" class="nav-content-bttn"
                                                             data-tab="settings"><i class="ti-settings"></i></a></li>
                    </ul>
                </div>
            </div>

            <div class="sidebar active" id="chats">
                <div class="text-left mb-1 mt-0">
                    <h2 class="title-text"><b>最近</b> 聊天列表</h2>
                </div>
                <div class="form-content">
                    <form action="#" class="mb-3 mt-3">
                        <label>
                            <input type="text" class="form-control" placeholder="搜索最近聊天">
                        </label>
                    </form>
                </div>
                <div class="chat-list-content">
                    <ul class="chat-list" id="user-chat-list">

                    </ul>
                </div>
            </div>
            <div class="sidebar" id="friends">
                <div class="text-left mb-2 mt-3">
                    <h2 class="title-text"><b>好友</b> 好友列表 </h2>
                </div>
                <div class="form-content">
                    <form action="#" class="mb-3 mt-1">
                        <label>
                            <input type="text" class="form-control" placeholder="搜索好友列表">
                        </label>
                    </form>
                </div>
                <div class="chat-list-content">
                    <ul class="chat-list" id="friend-list-area">
                        <li class="chat-list-item">
                            <figure class="avatar user-online">
                                <img src="images/user-2.png" alt="image">
                            </figure>
                            <div class="list-body">
                                <div class="chat-bttn">
                                    <h3 class="mb-1 mt-1" id="friend-name">Hurin Seary</h3>
                                    <p id="friend-motto">test user motto.</p>
                                </div>
                                <!-- <div class="list-action mt-2 text-right">
                                    <a href="#" class="btn-plus dropdown-toggle" data-toggle="dropdown"><i
                                            class="ti-plus"></i></a>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <a href="#" class="dropdown-item" id="addfriend-bttn">Add friend</a>
                                        <a href="#" class="dropdown-item">Restore</a>
                                        <div class="dropdown-divider"></div>
                                        <a href="#" class="dropdown-item text-danger">Delete</a>
                                    </div>
                                </div> -->
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="sidebar" id="group-chat">
                <div class="text-left mb-1 mt-0">
                    <h2 class="title-text"><b>群聊</b> 群聊列表</h2>
                </div>
                <div class="form-content">
                    <form action="#" class="mb-3 mt-3">
                        <label>
                            <input type="text" class="form-control" placeholder="搜索最近群聊">
                        </label>
                    </form>
                </div>
                <div class="chat-list-content">
                    <ul class="chat-list" id="group-chatting-list">

                    </ul>
                </div>
            </div>

            <div class="sidebar" id="settings">
                <div class="text-left mb-2 mt-3">
                    <h2 class="title-text"><b>账户</b> 设置您的账户 </h2>
                </div>
                <div class="chat-list-content mb-3 mt-3">
                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingOne">
                                <h4 class="panel-title"><a role="button" data-toggle="collapse"
                                                           data-parent="#accordion" href="#collapseOne"
                                                           aria-expanded="true"
                                                           aria-controls="collapseOne" class="collapsed">我的资料
                                    <span>修改资料</span></a>
                                </h4>
                            </div>
                            <div id="collapseOne" class="panel-collapse collapse" role="tabpanel"
                                 aria-labelledby="headingOne">
                                <div class="panel-body">
                                    <form action="#" class="mb-3 mt-3">
                                        <label>
                                            <input type="text" class="form-control mb-3" placeholder="用户名"
                                                   id="newUserName">
                                        </label>
                                        <label>
                                            <input type="text" class="form-control mb-3" placeholder="邮箱"
                                                   id="newUserEmail">
                                        </label>
                                        <label>
                                            <input type="text" class="form-control mb-3" placeholder="个性签名"
                                                   id="newUserMotto">
                                        </label>
                                        <button id="saveNewUserInfo">保存</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingTwo">
                                <h4 class="panel-title"><a role="button" data-toggle="collapse"
                                                           data-parent="#accordion" href="#collapseTwo"
                                                           aria-expanded="true"
                                                           aria-controls="collapseTwo" class="collapsed">隐私与安全设置
                                    <span>设置隐私与安全</span></a></h4>
                            </div>
                            <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel"
                                 aria-labelledby="headingTwo">
                                <div class="panel-body">
                                    <form action="#" class="mb-3 mt-3">
                                        <label>
                                            <input type="text" class="form-control mb-3" placeholder="原密码">
                                        </label>
                                        <label>
                                            <input type="text" class="form-control mb-3" placeholder="新密码">
                                        </label>
                                        <label>
                                            <input type="text" class="form-control mb-3" placeholder="重置密码">
                                        </label>
                                        <button id="">提交</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="chat-content">
            <!-- chat header -->
            <div class="chat-header">
                <div class="chat-header-user">
                    <figure class="avatar">
                        <img src="images/user-9.png" class="rounded-circle" alt="image">
                    </figure>
                    <div>
                        <h5 class="mt-2 mb-0" id="chatting-user">样例用户</h5>
                        <small class="text-success" id="chatting-status">样例个性签名</small>
                    </div>
                </div>
                <div class="chat-header-action">
                    <ul class="list-inline mb-0 mt-2">
                        <!--                        TODO:在这里安装文件上传功能-->
                        <li class="list-inline-item not-mobile">
                            <a href="#" class="bttn-box-round"
                               id="file-upload-bttn"><i
                                    class="ti-video-camera"></i></a>
                        </li>
                        <li class="list-inline-item not-mobile"><input type="file" id="upload-file-choose"></li>
                    </ul>
                </div>
            </div>
            <!-- chat header -->
            <!-- chat body -->
            <div class="chat-body" style="overflow: hidden;outline: none;">
                <div class="messages-content" id="messages-list">

                </div>
            </div>
            <!-- chat body -->
            <!-- chat footer -->
            <!--            放个iframe用来接收刷新操作，这样就不用刷新了-->
            <div class="chat-footer">
                <form action="#" target="iframe">
                    <input type="text" placeholder="请在这里输入您的消息..." id="user-message">
                    <button id="send-message"><img src="images/send.png" alt="send"></button>
                </form>
                <iframe id="iframe" name="iframe" style="display:none;"></iframe>
            </div>
            <!-- chat footer -->
        </div>

        <div class="right-sidebar" style="overflow: hidden;outline: none;">
            <div class="profile-content scroll-profile">
                <header>
                    <h2 class="title-text">个人资料</h2>
                    <a href="#" class="close-icon float-right"><i class="ti-close  text-danger"></i></a>
                </header>
                <div class="text-center mt-4">
                    <figure class="avatar avatar-xl mb-4">
                        <img src="images/user-10.png" class="rounded-circle" alt="image">
                    </figure>
                    <h5 class="mb-0" id="profile-name">James Henry</h5>
                    <small class="text-success" id="profile-email">james43@gmail.com</small>

                    <ul class="social-link list-inline mt-3">
                        <li class="list-inline-item"><a href="#"><i class="ti-facebook bg-facebook"></i></a></li>
                        <li class="list-inline-item"><a href="#"><i class="ti-twitter-alt bg-twitter"></i></a></li>
                        <li class="list-inline-item"><a href="#"><i class="ti-google bg-google"></i></a></li>
                        <li class="list-inline-item"><a href="#"><i class="ti-pinterest bg-pinterest"></i></a></li>
                        <li class="list-inline-item"><a href="#"><i class="ti-linkedin bg-linkedIn"></i></a></li>
                        <li class="list-inline-item"><a href="#"><i class="ti-github bg-github"></i></a></li>
                    </ul>

                    <ul class="profile-detail list-inline pt-5">
                        <li class="list-block-item text-left">
                            <h6 class="mb-0">账号</h6>
                            <small id="profile-id"></small>
                        </li>
                        <li class="list-block-item text-left">
                            <h6 class="mb-0">个性签名</h6>
                            <small id="profile-motto"></small>
                        </li>
                        <li class="list-block-item text-left">
                            <h6 class="mb-0">等级</h6>
                            <small id="profile-level"></small>
                        </li>
                        <li class="list-block-item text-left">
                            <h6 class="mb-0">创建时间</h6>
                            <small id="profile-create-time"></small>
                        </li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

</div>
<!-- main wrapper -->

<!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdn.goeasy.io/goeasy-2.2.2.min.js"></script>
<script src="js/plugin.js"></script>
<script src="js/main.min.js"></script>
<script type="text/javascript">
    const requestUrl = "http://localhost:8080/api/v1/user";
    // 某api的地址
    const goeasy = GoEasy.getInstance({
        host: "hangzhou.goeasy.io", //若是新加坡区域：singapore.goeasy.io
        appkey: "BC-f0ed0595dbd74b398fdfcac61b1f18d6",
        modules: ['im'] //根据需要，传入‘pubsub’或'im’，或数组方式同时传入
    });
    const im = goeasy.im;

    // 时间戳转化
    function add0(m) {
        return m < 10 ? '0' + m : m
    }

    function format(shijianchuo) {
        //shijianchuo是整数，否则要parseInt转换
        var time = new Date(shijianchuo);
        var y = time.getFullYear();
        var m = time.getMonth() + 1;
        var d = time.getDate();
        var h = time.getHours();
        var mm = time.getMinutes();
        var s = time.getSeconds();
        return y + '-' + add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm) + ':' + add0(s);
    }

    $(document).ready(function () {
        $.ajax({
            headers: {
                chattoken: localStorage.getItem("chattoken"),
            },
            url: requestUrl + "/" + localStorage.getItem("userId"),
            type: "GET",
            contentType: "application/json;charset=UTF-8",
            success: function (data) {
                console.log(data)
                $("#left-top-name").text(data.userName)
                $("#left-top-email").text(data.userEmail)
                $("#profile-id").text(localStorage.getItem("userId"))
                $("#profile-name").text(data.userName)
                $("#profile-email").text(data.userEmail)
                $("#profile-motto").text(data.userMotto)
                $("#profile-level").text(data.userLevel)
                $("#profile-create-time").text(data.userCreateTime)
            },
            error: function () {

            }
        })
        // 连接到聊天服务器
        console.log("connect")
        goeasy.connect({
            id: localStorage.getItem("userId"), //pubsub选填，im必填
            data: {
                "avatar": "/www/xxx.png",
                "nickname": "TestUser"
            }, //必须是一个对象，pubsub选填，im必填，用于上下线提醒和查询在线用户列表时，扩展更多的属性
            onSuccess: function () { //连接成功
                console.log("GoEasy connect successfully.") //连接成功
            },
            onFailed: function (error) { //连接失败
                console.log("Failed to connect GoEasy, code:" + error.code + ",error:" + error
                    .content);
            },
            onProgress: function (attempts) { //连接或自动重连中
                console.log("GoEasy is connecting", attempts);
            }
        });

        im.removePrivateConversation({
            userId: "1",
            onSuccess: function () {
                console.log("Remove private conversation successfully.");
            },
            onFailed: function (error) {
                console.log("Failed to remove private conversation, code:" + error.code + " content:" + error.content);
            }
        });
    })
    // 退出聊天服务器
    $("#log-out").click(function () {
        console.log("disconnect")
        goeasy.disconnect({
            onSuccess: function () {
                console.log("GoEasy disconnect successfully.") //断开服务器连接
            },
            onFailed: function (error) {
                console.log("Failed to disconnect GoEasy, code:" + error.code + ",error:" +
                    error.content); // 如果保存出错的话也得输出错误码
            }
        });
    })
    // 暂时获取聊天列表
    let ifChatListExists = false;
    $("#chat-list").click(function () {
            im.latestConversations({
                onSuccess: function (result) {
                    console.log(result);
                    $("#user-chat-list").html("")
                    $.each(result.content.conversations, function (index, item) {
                        let string = "";
                        if (item.unread == 0) {
                            string = "                        <li class=\"chat-list-item\" id='chat-item'>\n" +
                                "                            <figure class=\"avatar user-online\">\n" +
                                "                                <img src=\"images/user-2.png\" alt=\"image\">\n" +
                                "                            </figure>\n" +
                                "                            <div class=\"list-body\">\n" +
                                "                                <div class=\"chat-bttn\">\n" +
                                "                                    <h3 class=\"mb-0 mt-2\" id='chat-item-userid'>" + item.userId + "</h3>" +
                                "                                    <div>" + item.lastMessage.payload.text + "</div>\n" +
                                "                                </div>\n" +
                                "                                <div class=\"list-action mt-2 text-right\">\n" +
                                "                                    <small class=\"text-primary\">" + format(item.lastMessage.timestamp) + "</small>\n" +
                                "                                </div>\n" +
                                "                            </div>\n" +
                                "                        </li>"
                        } else {
                            string = "                        <li class=\"chat-list-item\" id='chat-item'>\n" +
                                "                            <figure class=\"avatar user-online\">\n" +
                                "                                <img src=\"images/user-2.png\" alt=\"image\">\n" +
                                "                            </figure>\n" +
                                "                            <div class=\"list-body\">\n" +
                                "                                <div class=\"chat-bttn\">\n" +
                                "                                    <h3 class=\"mb-0 mt-2\" id='chat-item-userid'>" + item.userId + "</h3>" +
                                "                                    <div>" + item.lastMessage.payload.text + "</div>\n" +
                                "                                </div>\n" +
                                "                                <div class=\"list-action mt-2 text-right\">\n" +
                                "                                    <div class=\"message-count bg-primary\">" + item.unread + "</div>\n" +
                                "                                    <small class=\"text-primary\">" + format(item.lastMessage.timestamp) + "</small>\n" +
                                "                                </div>\n" +
                                "                            </div>\n" +
                                "                        </li>"

                        }
                        $("#user-chat-list").append(string);
                    })
                },
                onFailed: function (error) { //获取失败
                    console.log("Failed to get the latest conversations, code:" + error.code + " content:" + error.content);
                },
            });
            var onConversationsUpdated = function (conversations) {
                console.log(conversations);
            };
            //监听会话列表更新
            im.on(GoEasy.IM_EVENT.CONVERSATIONS_UPDATED, onConversationsUpdated);
        }
    )

    // 获取好友列表
    let ifFriendListExists = false;
    $("#friend-list").click(function () {
        $.ajax({
            headers: {
                chattoken: localStorage.getItem("chattoken"),
            },
            url: requestUrl + "/friend_list/" + localStorage.getItem("userId"),
            type: "GET",
            contentType: "application/json;charset=UTF-8",
            success: function (data) {

                if (ifFriendListExists !== true) {
                    $.each(data, function (index, item) {
                        const string = "<li class='chat-list-item' id='friend-item'>" +
                            "<figure class='avatar user-online'>" +
                            "<img src='images/user-2.png' alt='image'>" + "</figure>" + "<div class='list-body'>" + "<div class='chat-bttn'>"
                            + "<h3 class='mb-1 mt-1' id='friend-name' >" + item.friendName + "(" + "<span id='friend-id'>" + item.friendId + "</span>" + ")" + "</h3 >" + "<p id='friend-motto'>" + item.friendMotto + "</p>" + "</div >" + "</div >" + "</li > ";
                        $("#friend-list-area").append(string)
                        ifFriendListExists = true;
                    })
                }
            },
            error: function (status) {
                console.log(status);
            },
        })
    })

    //设置具体的聊天窗口
    $("#user-chat-list").on("click", "#chat-item", function () {
        var userInfo;
        // 请求调整聊天窗口对应的数据
        const talkToId = $(this).find("#chat-item-userid")[0].innerHTML;
        $.ajax({
            headers: {
                chattoken: localStorage.getItem("chattoken")
            },
            url: requestUrl + "/" + talkToId,
            type: "GET",
            success: function (data) {
                $("#chatting-user").text(talkToId);
                $("#chatting-status").text(data.userMotto);
                // 每次请求历史记录前都把消息记录整个清理一遍？
                $("#messages-list").html("");
                im.history({
                    userId: talkToId,  //对方userId
                    lastTimestamp: Date.now(), //查询发送时间小于（不包含）该时间的历史消息，可用于分页和分批拉取聊天记录，默认为当前时间
                    // 对消息条数不做限制
                    onSuccess: function (result) {
                        $.each(result.content, function (index, item) {
                            if (item.senderId == $("#chat-item-userid")[0].innerHTML) {
                                var string;
                                if (item.type !== "file") {
                                    string = "                            <div\n" +
                                        "                        class = \"message-item\" >\n" +
                                        "                            <div\n" +
                                        "                        class = \"message-user\" >\n" +
                                        "                            <figure\n" +
                                        "                        class = \"avatar\" >\n" +
                                        "                            <img\n" +
                                        "                        src = \"images/user-9.png\"\n" +
                                        "                        alt = \"image\"\n" +
                                        "                        id = \"chat-message-avatar\" >\n" +
                                        "                            </figure>\n" +
                                        "                        <div>\n" +
                                        "                            <h5 id=\"chat-message-sender\">" + item.senderId + "</h5>\n" +
                                        "                            <div class=\"time\" id=\"chat-message-time\">" + format(item.timestamp) + "</div>\n" +
                                        "                        </div>\n" +
                                        "                    </div>\n" +
                                        "                        <div class=\"message-wrap\" id=\"chat-message-body\">" + item.payload.text + "</div>\n" +
                                        "                    </div>"
                                } else {
                                    string = "                            <div\n" +
                                        "                        class = \"message-item\" >\n" +
                                        "                            <div\n" +
                                        "                        class = \"message-user\" >\n" +
                                        "                            <figure\n" +
                                        "                        class = \"avatar\" >\n" +
                                        "                            <img\n" +
                                        "                        src = \"images/user-9.png\"\n" +
                                        "                        alt = \"image\"\n" +
                                        "                        id = \"chat-message-avatar\" >\n" +
                                        "                            </figure>\n" +
                                        "                        <div>\n" +
                                        "                            <h5 id=\"chat-message-sender\">" + item.senderId + "</h5>\n" +
                                        "                            <div class=\"time\" id=\"chat-message-time\">" + format(item.timestamp) + "</div>\n" +
                                        "                        </div>\n" +
                                        "                    </div>\n" +
                                        "                        <div class=\"message-wrap\" id=\"chat-message-body\">" + item.payload.url + "</div>\n" +
                                        "                    </div>"
                                }
                                $("#messages-list").append(string);
                            } else {
                                var string;
                                if (item.type !== "file") {
                                    string = "                            <div class=\"message-item outgoing-message\">\n" +
                                        "                                <div class=\"message-user\">\n" +
                                        "                                    <figure class=\"avatar\">\n" +
                                        "                                        <img src=\"images/user-1.png\" alt=\"image\">\n" +
                                        "                                    </figure>\n" +
                                        "                                    <div>\n" +
                                        "                                        <h5>" + item.senderId + "</h5>\n" +
                                        "                                        <div class=\"time\">" + format(item.timestamp) + "<i class=\"ti-double-check text-info\"></i></div>\n" +
                                        "                                    </div>\n" +
                                        "                                </div>\n" +
                                        "                                <div class=\"message-wrap\">" + item.payload.text +
                                        "                                </div>\n" +
                                        "                            </div>"

                                } else {
                                    string = "                            <div class=\"message-item outgoing-message\">\n" +
                                        "                                <div class=\"message-user\">\n" +
                                        "                                    <figure class=\"avatar\">\n" +
                                        "                                        <img src=\"images/user-1.png\" alt=\"image\">\n" +
                                        "                                    </figure>\n" +
                                        "                                    <div>\n" +
                                        "                                        <h5>" + item.senderId + "</h5>\n" +
                                        "                                        <div class=\"time\">" + format(item.timestamp) + "<i class=\"ti-double-check text-info\"></i></div>\n" +
                                        "                                    </div>\n" +
                                        "                                </div>\n" +
                                        "                                <div class=\"message-wrap\">" + item.payload.url +
                                        "                                </div>\n" +
                                        "                            </div>"
                                }
                                $("#messages-list").append(string);
                            }
                        })
                    },
                    onFailed: function (error) { //获取失败
                        console.log("Failed to query private message, code:" + error.code + " content:" + error.content);
                    },
                });
            },
            error: function (data) {
                console.log(data);
            }
        })
    })

    $("#friend-list-area").on("click", "#friend-item", function () {
        $("#chatting-user").text($(this).find("#friend-id")[0].innerHTML);
        $("#chatting-status").text($(this).find("#friend-motto")[0].innerHTML);
        $("#messages-list").html("");
        console.log($(this).find("#friend-id")[0].innerHTML)
        const checkUser = $(this).find("#friend-id")[0].innerHTML;
        $("messages-list").text("")
        im.history({
            userId: $(this).find("#friend-id")[0].innerHTML,  //对方userId
            lastTimestamp: Date.now(), //查询发送时间小于（不包含）该时间的历史消息，可用于分页和分批拉取聊天记录，默认为当前时间
            // 对消息条数不做限制
            onSuccess: function (result) {
                $.each(result.content, function (index, item) {
                    if (item.senderId == checkUser) {
                        const string = "                            <div\n" +
                            "                        class = \"message-item\" >\n" +
                            "                            <div\n" +
                            "                        class = \"message-user\" >\n" +
                            "                            <figure\n" +
                            "                        class = \"avatar\" >\n" +
                            "                            <img\n" +
                            "                        src = \"images/user-9.png\"\n" +
                            "                        alt = \"image\"\n" +
                            "                        id = \"chat-message-avatar\" >\n" +
                            "                            </figure>\n" +
                            "                        <div>\n" +
                            "                            <h5 id=\"chat-message-sender\">" + item.senderId + "</h5>\n" +
                            "                            <div class=\"time\" id=\"chat-message-time\">" + format(item.timestamp) + "</div>\n" +
                            "                        </div>\n" +
                            "                    </div>\n" +
                            "                        <div class=\"message-wrap\" id=\"chat-message-body\">" + item.payload.text + "</div>\n" +
                            "                    </div>"
                        $("#messages-list").append(string)
                    } else {
                        const string = "                            <div class=\"message-item outgoing-message\">\n" +
                            "                                <div class=\"message-user\">\n" +
                            "                                    <figure class=\"avatar\">\n" +
                            "                                        <img src=\"images/user-1.png\" alt=\"image\">\n" +
                            "                                    </figure>\n" +
                            "                                    <div>\n" +
                            "                                        <h5>" + item.senderId + "</h5>\n" +
                            "                                        <div class=\"time\">" + format(item.timestamp) + "<i class=\"ti-double-check text-info\"></i></div>\n" +
                            "                                    </div>\n" +
                            "                                </div>\n" +
                            "                                <div class=\"message-wrap\">" + item.payload.text +
                            "                                </div>\n" +
                            "                            </div>"
                        $("#messages-list").append(string)
                    }
                })
            },
            onFailed: function (error) { //获取失败
                console.log(error);
            },
        });
    })

    $("#send-message").click(function () {

        //发送消息，群聊和私聊是有条件的
        if ($("#chatting-user").text() !== "" && $("#chatting-user").text() !== "fw联盟") {
            //创建消息, 内容最长不超过3K，可以发送字符串，对象和json格式字符串
            let textMessage = im.createTextMessage({
                text: $("#user-message").val(), //消息内容
                to: {
                    type: GoEasy.IM_SCENE.PRIVATE,   //私聊还是群聊，群聊为GoEasy.IM_SCENE.GROUP
                    id: $("#chatting-user").text(),
                    data: {"avatar": "/www/xxx.png", "nickname": "Neo"} //好友扩展数据, 任意格式的字符串或者对象，用于更新会话列表conversation.data
                }
            });
            im.sendMessage({
                message: textMessage,
                onSuccess: function (message) { //发送成功
                    console.log("Private message sent successfully.", message);
                },
                onFailed: function (error) { //发送失败
                    console.log('Failed to send private message，code:' + error.code + ' ,error ' + error.content);
                }
            });
        } else if ($("#chatting-user").text() !== "" && $("#chatting-user").text() === "fw联盟") {
            var textMessage = im.createTextMessage({
                text: $("#user-message").val(), //消息内容
                to: {
                    type: GoEasy.IM_SCENE.GROUP,   //群聊
                    id: 'fw联盟',  //群id
                    data: {"avatar": "/www/xxx.png", "nickname": "fw联盟"} //群信息, 任意格式的字符串或者对象，用于更新会话列表中的群信息conversation.data
                }
            });
            //发送消息
            im.sendMessage({
                message: textMessage,
                onSuccess: function (message) {  //发送成功
                    console.log("Group message sent successfully.", message);
                },
                onFailed: function (error) { //发送失败
                    console.log("Failed to send group message, code:" + error.code + ",error:" + error.content);
                }
            });
        }
    })

    var onPrivateMessageReceived = function (message) {
        console.log("received private message:" + JSON.stringify(message));
    };
    //监听和接收单聊消息
    im.on(GoEasy.IM_EVENT.PRIVATE_MESSAGE_RECEIVED, onPrivateMessageReceived);

    var onGroupMessageReceived = function (message) {
        console.log("received group message:" + JSON.stringify(message));
    };
    //接收群消息
    im.on(GoEasy.IM_EVENT.GROUP_MESSAGE_RECEIVED, onGroupMessageReceived);

    // 群聊模块
    //TODO:群聊最关键的是人和人的消息发送必须要清楚
    var theOnlyGroup = false;
    $("#group-chat-list").click(function () {
        console.log("1");
        if (theOnlyGroup === false) {
            const theGroup = "                        <li class=\"chat-list-item\" id='group-chat-item'>\n" +
                "                            <figure class=\"avatar user-online\">\n" +
                "                                <img src=\"images/user-2.png\" alt=\"image\">\n" +
                "                            </figure>\n" +
                "                            <div class=\"list-body\">\n" +
                "                                <div class=\"chat-bttn\">\n" +
                "                                    <h3 class=\"mb-0 mt-2\" id='group-chat-groupid'>" + "fw联盟" + "</h3>" +
                "                                </div>\n" +
                "                                <div class=\"list-action mt-2 text-right\">\n" +
                "                                    <small class=\"text-primary\"> </small>\n" +
                "                                </div>\n" +
                "                            </div>\n" +
                "                        </li>"
            theOnlyGroup = true;
            $("#group-chatting-list").append(theGroup)
        }

        //订阅群消息
        var groupIds = ["fw联盟"];
        im.subscribeGroup({
            groupIds: groupIds,
            onSuccess: function () {  //订阅成功
                console.log("Group message subscribe successfully.");
            },
            onFailed: function (error) { //订阅失败
                console.log("Failed to subscribe group message, code:" + error.code + " content:" + error.content);
            }
        });
    })
    // 群聊的消息窗口更新
    $("#group-chatting-list").on("click", "#group-chat-item", function () {
        console.log($("#group-chat-groupid").text());
        $("#chatting-user").text($("#group-chat-groupid").text());
        $("#chatting-status").text($("#group-chat-groupid").text());
        $("#messages-list").html("");
        im.history({
            groupId: "fw联盟", //groupId
            lastTimestamp: Date.now(),  //查询发送时间小于（不包含）该时间的历史消息，可用于分页和分批拉取聊天记录，默认为当前时间
            limit: 10, //可选项，返回的消息条数，默认为10条，最多30条
            onSuccess: function (result) {
                $.each(result.content, function (index, item) {
                    if (item.senderId !== localStorage.getItem("userId")) {
                        const messageBubble = "                            <div\n" +
                            "                        class = \"message-item\" >\n" +
                            "                            <div\n" +
                            "                        class = \"message-user\" >\n" +
                            "                            <figure\n" +
                            "                        class = \"avatar\" >\n" +
                            "                            <img\n" +
                            "                        src = \"images/user-9.png\"\n" +
                            "                        alt = \"image\"\n" +
                            "                        id = \"chat-message-avatar\" >\n" +
                            "                            </figure>\n" +
                            "                        <div>\n" +
                            "                            <h5 id=\"chat-message-sender\">" + item.senderId + "</h5>\n" +
                            "                            <div class=\"time\" id=\"chat-message-time\">" + format(item.timestamp) + "</div>\n" +
                            "                        </div>\n" +
                            "                    </div>\n" +
                            "                        <div class=\"message-wrap\" id=\"chat-message-body\">" + item.payload.text + "</div>\n" +
                            "                    </div>"
                        $("#messages-list").append(messageBubble)
                    } else {
                        const messageBubble = string = " <div class=\"message-item outgoing-message\">\n" +
                            "                                <div class=\"message-user\">\n" +
                            "                                    <figure class=\"avatar\">\n" +
                            "                                        <img src=\"images/user-1.png\" alt=\"image\">\n" +
                            "                                    </figure>\n" +
                            "                                    <div>\n" +
                            "                                        <h5>" + item.senderId + "</h5>\n" +
                            "                                        <div class=\"time\">" + format(item.timestamp) + "<i class=\"ti-double-check text-info\"></i></div>\n" +
                            "                                    </div>\n" +
                            "                                </div>\n" +
                            "                                <div class=\"message-wrap\">" + item.payload.text +
                            "                                </div>\n" +
                            "                            </div>"
                        $("#messages-list").append(messageBubble)
                    }
                })
            },
            onFailed: function (error) { //获取失败
                console.log("Failed to query group message, code:" + error.code + " content:" + error.content);
            },
        });
        $("#messages-list").html("");

    })

    // 文件上传模块
    //TODO:用阿里云OSS去了，已经在goeasy里配好了，现在需要写一个文件上传按钮，然后把对应的函数放进去就可以了
    $("#file-upload-bttn").click(function () {
        const uploadFileMessage = im.createFileMessage(
            {
                file: document.getElementById('upload-file-choose').files[0], //Html获得file对象
                to: {
                    type: GoEasy.IM_SCENE.PRIVATE,   //私聊还是群聊，群聊为GoEasy.IM_SCENE.GROUP
                    id: $("#chatting-user").text(),
                    data: {"avatar": "/www/xxx.png", "nickname": "Neo"} //好友扩展数据, 任意格式的字符串或者对象，用于更新会话列表conversation.data
                },
                onProgress: function (event) {
                    console.log('file uploading:', event)
                }//获取上传进度
            }
        )
        im.sendMessage({
            message: uploadFileMessage,
            onSuccess: function (message) {  //发送成功
                console.log('Message sent successfully.', message);
            },
            onFailed: function (error) { //发送失败
                console.log('Failed to send message，code:' + error.code + ',error' + error.content);
            }
        });
    })

    // 用户信息修改模块
    // TODO:个人信息还没写完，其他都完了
    $("#saveNewUserInfo").click(function () {
        const newUserName = $("#newUserName").text();
        const newUserEmail = $("#newUserEmail").text();
        const newUserMotto = $("#newUserMotto").text();
        const newUserInfo = JSON.stringify({newUserName, newUserEmail, newUserMotto});
        $.ajax({
            url: requestUrl + "/" + localStorage.getItem("userId"),
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                chattoken: localStorage.getItem("chattoken")
            },
            data: newUserInfo,
            onSuccess: function (result) {
                console.log(result.status);
            }
        })
    })


</script>

</body>

</html>